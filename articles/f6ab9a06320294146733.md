---
title: "Goã«ãŠã‘ã‚‹ãƒã‚¤ãƒ³ã‚¿ã®ä½¿ã„ã©ã“ã‚"
emoji: "ğŸ˜Š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["go"]
published: true
---

Goã«ã¯ãƒã‚¤ãƒ³ã‚¿ã®æ¦‚å¿µãŒå­˜åœ¨ã—ã¾ã™
ãƒã‚¤ãƒ³ã‚¿ã«ã‚ˆã‚‹å¤‰æ•°ã®å—ã‘æ¸¡ã—ã¯ã€å€¤ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹å¿…è¦ãŒãªãã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¸¡ã™ã ã‘ã§å®Œäº†ã™ã‚‹ã®ã§åŠ¹ç‡çš„ã§ã™ãŒã€Goã®å ´åˆãƒã‚¤ãƒ³ã‚¿ã‚’ä½¿ã„ã™ãã‚‹ã¨ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«è² è·ãŒã‹ã‹ã£ã¦ã—ã¾ã„ã€å¤šãã®CPUæ™‚é–“ã‚’æ¶ˆè²»ã™ã‚‹ã‚ˆã†ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã«Sã¨ã„ã†structã‚’ã€ã‚³ãƒ”ãƒ¼ã—ã¦è¿”ã™é–¢æ•°ã€ãƒã‚¤ãƒ³ã‚¿ã§è¿”ã™é–¢æ•°ã‚’ãã‚Œãã‚Œç”¨æ„ã—ã¾ã™

```go
type S struct {
  a, b, c int64
  d, e, f string
  g, h, i float64
}

func byCopy() S {
  return S{
    a: 1, b: 1, c: 1,
    e: "foo", f: "foo",
    g: 1.0, h: 1.0, i: 1.0,
  }
}

func byPointer() *S {
  return &S{
    a: 1, b: 1, c: 1,
    e: "foo", f: "foo",
    g: 1.0, h: 1.0, i: 1.0,
  }
}
```

ç”¨æ„ã—ãŸé–¢æ•°ã‚’å¯¾è±¡ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å–ã‚‹ã¨


```go
func BenchmarkStack(b *testing.B) {
  var s S

  f, err := os.Create("stack.out")
  if err != nil {
          panic(err)
  }
  defer f.Close()

  err = trace.Start(f)
  if err != nil {
          panic(err)
  }

  for i := 0; i < b.N; i++ {
          s = byCopy()
  }

  trace.Stop()

  b.StopTimer()

  _ = fmt.Sprintf("%v", s.a)
}

func BenchmarkMemoryHeap(b *testing.B) {
  var s *S

  f, err := os.Create("heap.out")
  if err != nil {
          panic(err)
  }
  defer f.Close()

  err = trace.Start(f)
  if err != nil {
          panic(err)
  }

  for i := 0; i < b.N; i++ {
          s = byPointer()
  }

  trace.Stop()

  b.StopTimer()

  _ = fmt.Sprintf("%v", s.a)
}
```

ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœãŒå¾—ã‚‰ã‚Œã¾ã™(go version go1.15.6 linux/amd64)
ã‚³ãƒ”ãƒ¼ã™ã‚‹é–¢æ•°ã®æ–¹ãŒè‰¯ã„çµæœãŒå‡ºã¦ã¾ã™

```go
BenchmarkStack                127888153              9.41 ns/op              0 B/op          0 allocs/op
BenchmarkMemoryHeap           16394270              68.2 ns/op              96 B/op          1 allocs/op
```

> [Go: Should I Use a Pointer instead of a Copy of my Struct?](https://medium.com/a-journey-with-go/go-should-i-use-a-pointer-instead-of-a-copy-of-my-struct-44b43b104963#:~:text=Conclusion,semantic%20written%20by%20Bill%20Kennedy.) (ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å¼•ç”¨å…ƒ)
[Go ã®GCã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒé«˜ããªã‚‹ã‚±ãƒ¼ã‚¹ã¨ã€ãã®å›é¿ç­–](https://qiita.com/imoty/items/c1017099e63cd4630946)

## ä½¿ã„ã©ã“ã‚

ã§ã¯ã©ã®ã‚ˆã†ãªå ´é¢ã§ãƒã‚¤ãƒ³ã‚¿ã¯ä½¿ã‚ã‚Œã‚‹ã¹ããªã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

### å¼•æ•°ã‚„ãƒ¬ã‚·ãƒ¼ãƒã‚’é–¢æ•°å†…ã§æ›¸ãæ›ãˆã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆ

å¼•æ•°ã‚„ãƒ¬ã‚·ãƒ¼ãƒã‚’é–¢æ•°å†…ã§æ›¸ãæ›ãˆã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã€æ›¸ãæ›ãˆã‚‹å¯¾è±¡ã¯ãƒã‚¤ãƒ³ã‚¿ã§æ¸¡ã™å¿…è¦ãŒã‚ã‚Šã¾ã™

```go
type S struct { value string }

func (s S) SetA (v string) {
  s.value = v
}

func (s *S) SetB (v string) {
  s.value = v
}

func main() {
  var s S
  s.SetA("a")
  fmt.Println(s.value) // sã¯ã‚¼ãƒ­ä¾¡ã®ã¾ã¾
  s.SetB("b")
  fmt.Println(s.value) // b
}
```

[go playgroundã§è©¦ã™](https://play.golang.org/p/JW_w9Cb2JNu)

é€†ã«é–¢æ•°å†…ã§ãƒ¬ã‚·ãƒ¼ãƒã«å¤‰æ›´ã‚’åŠ ãˆãªã„é–¢æ•°ã¯ã€å€¤ãƒ¬ã‚·ãƒ¼ãƒã‚’ä½¿ã£ãŸæ–¹ãŒã€Œã“ã®é–¢æ•°ã¯ãƒ¬ã‚·ãƒ¼ãƒã«å¤‰æ›´ã‚’åŠ ãˆãªã„ã€ã¨ã„ã†ã®ãŒã‚·ã‚°ãƒãƒãƒ£ã ã‘ã§æ˜ç¤ºçš„ã«ãªã‚‹ã®ã§ã€å¯èª­æ€§ã®è¦³ç‚¹ã§ã‚‚å¥½ã¾ã—ã„ã¨æ€ã‚ã‚Œã¾ã™

> [Effective Go (Pointers vs Values)](https://golang.org/doc/effective_go.html#pointers_vs_values)
[Uber Go Style Guide æ—¥æœ¬èªè¨³ (Receivers and Interfaces)](https://github.com/knsh14/uber-style-guide-ja/blob/master/guide.md#receivers-and-interfaces)

### ã‚³ãƒ”ãƒ¼ã‚’é¿ã‘ãŸã„ãƒ‡ãƒ¼ã‚¿ã‚’å¼•æ•°ã€ãƒ¬ã‚·ãƒ¼ãƒã«ã™ã‚‹å ´åˆ

`os.File` ã‚„ `sync.Mutex` ãªã©ã‚³ãƒ”ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã¨å•é¡ŒãŒç”Ÿã˜ã‚‹ã‚ˆã†ãªæ§‹é€ ä½“ã®å ´åˆã¯ã€ãƒã‚¤ãƒ³ã‚¿ã§æ‰±ã†ã“ã¨ã§ã‚³ãƒ”ãƒ¼ã•ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã™

```go
// os.Open ã§ã¯ File å‹ã‚’ãƒã‚¤ãƒ³ã‚¿ã§è¿”ã—ã¦ã„ã‚‹
func Open(name string) (file *File, err error) {
  return OpenFile(name, O_RDONLY, 0)
}
```

> [Go Code Review Comments æ—¥æœ¬èªè¨³ (Receiver Type)](https://gist.github.com/knsh14/0507b98c6b62959011ba9e4c310cd15d#receiver-type)
[Design Philosophy On Data And Semantics](https://www.ardanlabs.com/blog/2017/06/design-philosophy-on-data-and-semantics.html)

### ãƒ¬ã‚·ãƒ¼ãƒãŒå¤§ããªæ§‹é€ ä½“ã‚„é…åˆ—ã®å ´åˆ

ãƒ¬ã‚·ãƒ¼ãƒãŒå¤§ããªæ§‹é€ ä½“ã‚„é…åˆ—ã®å ´åˆã¯ãƒã‚¤ãƒ³ã‚¿ã‚’ä½¿ã†æ–¹ãŒåŠ¹ç‡çš„ã§ã™
ã€Œå¤§ãã„ã€ã®åŸºæº–ã¯ Go Code Review Comments ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã‹ã‚Œã¦ã„ã¾ã™

> ã‚‚ã—æ§‹é€ ä½“ã®å…¨ã¦ã®å€¤ã‚’å¼•æ•°ã«æ¸¡ã™ã¨ä»®å®šã—ã¦ãã ã•ã„ã€‚å¤šã™ãã‚‹ã¨æ„Ÿã˜ãŸãªã‚‰ã€ãã‚Œã¯ãƒã‚¤ãƒ³ã‚¿ã«ã—ã¦ã‚‚è‰¯ã„ãã‚‰ã„ã®å¤§ãã•ã§ã™ã€‚

`int`ã‚„`string`ãªã©ã®ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ãªå‹ã‚„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå¤šããªã„æ§‹é€ ä½“ã«é–¢ã—ã¦ã¯ã€ã‚³ãƒ”ãƒ¼ã®ã‚³ã‚¹ãƒˆã¯ã‚ã¾ã‚Šæ°—ã«ãªã‚‰ãšã€ã‚€ã—ã‚ãƒã‚¤ãƒ³ã‚¿ã§æ‰±ã£ãŸæ–¹ãŒGCã®å…¼ã­åˆã„ã§éåŠ¹ç‡ã«ãªã‚‹ã®ã§ã€å€¤ãƒ¬ã‚·ãƒ¼ãƒã«ã—ãŸæ–¹ãŒè‰¯ã„ã¨ã„ã†ã“ã¨ã ã¨æ€ã„ã¾ã™

> [Go Code Review Comments æ—¥æœ¬èªè¨³ (Receiver Type)](https://gist.github.com/knsh14/0507b98c6b62959011ba9e4c310cd15d#receiver-type)
